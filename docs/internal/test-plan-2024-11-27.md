# Test Failures Plan – 2024-11-27

## Issues
- Tool outputSchema not enforced: `tools/call` accepts outputs that don’t match declared schemas, so `test_tools_schema.sh` cannot surface an error for malformed structured output.
- Manual tool registration not applied in staged workspaces: `test_tools.sh` manual-alpha block sees empty structuredContent because the test-provided `server.d/register.sh` is not honored during registry refresh.

## Evidence
- `test/integration/run.sh` failures:
  - `test_tools_schema.sh`: “schema mismatch did not produce error”.
  - `test_tools.sh`: “expected one, got <empty>” for manual-alpha structuredContent.
- Current `lib/tools.sh` builds results without any schema check; stdout is treated as opaque.
- `mcp_tools_run_manual_script` only executes if the staged `server.d/register.sh` is executable; the test workspace still loads the default `server.d/register.sh`, so manual registrations from the test are skipped.

## Suggested Fix
- Implement strict outputSchema validation in `lib/tools.sh`:
  - When `outputSchema` exists, require stdout to be valid JSON and validate required fields/types.
  - On mismatch, return `-32603` with `_meta.stderr`/structured error and `isError=true`; reject non-JSON output for schema-declared tools.
- Ensure manual registry overrides are used in tests:
  - In test staging, remove/ignore the default `server.d/register.sh` so the test’s `server.d/register.sh` drives registry refresh; or update `test_stage_workspace` to prefer test-provided register.sh when present.
- After fixes, re-run `test/integration/run.sh` to confirm `test_tools_schema.sh` and manual-alpha in `test_tools.sh` pass.***
